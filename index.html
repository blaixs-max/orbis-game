<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Redline: Balanced v9</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-touch-callout: none; }
        
        /* SİNEMATİK UI */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; z-index: 10;
            background: radial-gradient(circle, transparent 50%, #000 140%);
        }
        
        .hud-top { display: flex; justify-content: space-between; width: 100%; margin-top: 10px; }
        .hud-metric { text-align: center; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .hud-metric span { display: block; font-size: 10px; letter-spacing: 2px; opacity: 0.7; }
        .hud-metric strong { font-size: 28px; font-weight: 300; }

        #center-speed { text-align: center; margin-top: 50px; }
        #speed-val { font-size: 80px; color: #fff; font-weight: 100; letter-spacing: -2px; text-shadow: 0 0 20px rgba(0,200,255,0.6); }
        #speed-unit { font-size: 14px; color: #00ccff; letter-spacing: 5px; font-weight: bold; }

        /* UYARI */
        #danger-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            box-shadow: inset 0 0 100px rgba(255,0,0,0);
            pointer-events: none; transition: box-shadow 0.5s; z-index: 5;
        }

        /* NITRO BUTONU */
        #nitro-btn {
            pointer-events: auto;
            width: 100px; height: 100px;
            position: absolute; bottom: 40px; right: 30px;
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 14px; font-weight: bold; letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(0,255,255,0.1);
            transition: 0.2s;
        }
        #nitro-btn.active {
            background: rgba(0,255,255,0.2);
            box-shadow: 0 0 40px rgba(0,255,255,0.6), inset 0 0 20px rgba(0,255,255,0.4);
            border-color: #fff; transform: scale(0.95);
        }

        /* MENÜLER */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 50;
        }
        h1 { color: #fff; font-weight: 100; font-size: 40px; letter-spacing: 8px; margin-bottom: 10px; text-shadow: 0 0 20px #fff; }
        button {
            background: transparent; border: 1px solid rgba(255,255,255,0.3); color: #fff;
            padding: 15px 40px; font-size: 18px; margin: 10px; letter-spacing: 2px;
            cursor: pointer; transition: 0.3s; text-transform: uppercase; border-radius: 4px;
        }
        button:hover { background: #fff; color: #000; box-shadow: 0 0 20px #fff; }
    </style>
</head>
<body>

    <div id="danger-overlay"></div>

    <div id="ui-layer" style="display:none;">
        <div class="hud-top">
            <div class="hud-metric"><span>SKOR</span><strong id="score">0</strong></div>
            <div class="hud-metric"><span>BAKİYE</span><strong id="gold" style="color:#ffd700">0</strong></div>
        </div>
        
        <div id="center-speed">
            <div id="speed-val">0</div>
            <div id="speed-unit">KM/H</div>
        </div>

        <div id="nitro-btn" ontouchstart="activateNitro()" ontouchend="deactivateNitro()" onmousedown="activateNitro()" onmouseup="deactivateNitro()">
            TURBO
        </div>
    </div>

    <div id="menu" class="screen">
        <h1>REDLINE</h1>
        <p style="color:#888; margin-bottom:30px;">BALANCED EDITION v9</p>
        <button onclick="reqPerm()">YARIŞA BAŞLA</button>
    </div>

    <div id="gameover" class="screen" style="display:none;">
        <h1 style="color:#ff3333;">KAZA!</h1>
        <p style="color:#fff; margin-bottom:20px;">SKOR: <span id="end-score">0</span></p>
        <button onclick="resetGame()">MENÜYE DÖN</button>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';
        import { EffectComposer } from 'https://cdn.skypack.dev/three@0.132.2/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.132.2/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'https://cdn.skypack.dev/three@0.132.2/examples/jsm/postprocessing/UnrealBloomPass.js';

        // --- YENİ HIZ AYARLARI ---
        const BIKE_STATS = { 
            spd: 200,    // Max Hız düşürüldü (Eskisi 320)
            hnd: 0.12,   // Kontrol biraz yumuşatıldı
            nit: 1.2     // Nitro dolum hızı
        };

        let scene, camera, renderer, composer;
        let player, roadParts=[], enemies=[], particles=[];
        let gameActive = false;
        let speed=0, score=0, nitro=100;
        let tiltX=0, playerX=0;
        let isNitro=false;
        
        // Asfalt Dokusu
        function createAsphaltTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0,0,512,512);
            for(let i=0; i<40000; i++) {
                ctx.fillStyle = Math.random() > 0.5 ? '#222' : '#111';
                ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2);
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(1, 4); return tex;
        }
        const asphaltTex = createAsphaltTexture();

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x020205, 0.02); 

            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 3, 6);
            camera.rotation.x = -0.25;

            renderer = new THREE.WebGLRenderer({antialias:false});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.body.appendChild(renderer.domElement);

            // Post Processing
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0; bloomPass.strength = 1.0; bloomPass.radius = 0.5;

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // Işıklar
            const hemi = new THREE.HemisphereLight(0xffffff, 0x000000, 0.2);
            scene.add(hemi);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(0, 20, -10);
            scene.add(dirLight);

            createRoad();
            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function createPlayer() {
            if(player) scene.remove(player);
            player = new THREE.Group();

            // Gövde
            const bodyMat = new THREE.MeshStandardMaterial({color:0x111111, roughness:0.2, metalness:0.8});
            const body